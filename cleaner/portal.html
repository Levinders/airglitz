<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HomeGlitz ‚Äî Cleaner Portal</title>
<link rel="icon" href="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/64%C3%9764pxlogo.png"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#0F72B4;
    --panel:#ffffff;
    --muted:#6c757d;
    --success:#16a34a;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.72);
    --radius:14px;
    --shadow: 0 10px 30px rgba(12,60,120,0.06);
    --max-w:1080px;
  }
  *{box-sizing:border-box;font-family:'Montserrat',sans-serif}
  html,body{height:100%;margin:0;background:#f5faff;color:#111;-webkit-font-smoothing:antialiased}
  a{color:inherit}

  /* Header */
  .header{
    position:sticky;top:0;z-index:60;
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;padding:12px 16px;background:var(--panel);border-bottom:1px solid #eef6fb;
    box-shadow: 0 2px 10px rgba(12,60,120,0.02);
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:800;color:var(--primary)}
  .brand img{height:38px;border-radius:8px}
  .header-right{display:flex;gap:12px;align-items:center}
  .avatar{width:40px;height:40px;border-radius:10px;background:#f0f6fb;display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)}

  /* Layout */
  .page {max-width:var(--max-w);margin:20px auto;padding:0 16px}
  .grid {display:grid;grid-template-columns: 1fr 320px;gap:18px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .side{display:none} }

  /* Side nav (desktop) */
  .side { background:var(--panel);padding:16px;border-radius:12px;border:1px solid #eaf2fb; height:fit-content }
  .side .profile{display:flex;gap:12px;align-items:center;margin-bottom:12px}
  .side a{display:block;padding:10px;border-radius:10px;color:var(--muted);text-decoration:none;margin-bottom:8px;font-weight:700}
  .side a.active{background:#f8fbff;color:var(--primary);box-shadow:0 6px 18px rgba(15,114,180,.04)}

  /* Main card */
  .card{background:var(--panel);border-radius:14px;padding:14px;border:1px solid #eaf2fb;box-shadow:var(--shadow);margin-bottom: 50px;}
  .top-controls{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;flex-wrap:wrap}
  .filters{display:flex;gap:8px;align-items:center}
  .filters input, .filters select{padding:8px 12px;border-radius:10px;border:1px solid #e6eef8;font-size:14px}
  .btn{padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .btn-primary{background:var(--primary);color:#fff}
  .chip{background:#f8fbff;padding:6px 10px;border-radius:999px;border:1px solid #e6eef8;font-weight:400;color:var(--primary)}

  .summary {
  display: flex;
  flex-direction: row !important;
  align-items: center;
  gap: 10px;
  flex-wrap: nowrap;
  overflow-x: auto;
  padding: 4px 0;
    width: 200px;
}

  .icon-chip {
  font-size: 18px;
  width: 36px;
  height: 36px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  border-radius:999px;
  padding:0;
  flex-shrink: 0; /* important: prevents squishing */
}


.icon-chip::after {
  content: attr(data-count);
  position:absolute;
  top:-5px;
  right:-5px;
  background:var(--primary);
  color:#fff;
  font-size:10px;
  padding:2px 5px;
  border-radius:999px;
}




  /* Table / cards */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:12px;border-bottom:1px solid #f1f5f9;text-align:left}
  th{background:#f9fbfd;color:var(--primary);font-weight:800}
  tr:hover td{background:#fbfdff}
  .status-badge{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px;display:inline-block}
  .s-pending{background:#fff7ed;border:1px solid #ffe7c7;color:#b45309}
  .s-underway{background:#eef9f1;border:1px solid #c7f0d2;color:var(--success)}
  .s-completed{background:#eef2ff;border:1px solid #e0d7ff;color:var(--primary)}
  .s-cancelled{background:#fff1f2;border:1px solid #ffd6dc;color:var(--danger)}

  /* Drawer */
/* ================================
   NEW POLISHED DRAWER (DESKTOP + MOBILE)
   ================================ */

.drawer {
  position: fixed;
  right: 24px;
  bottom: 24px;
  width: 420px;
  max-width: 95%;
  background: #fff;
  border-radius: 20px;
  border: 1px solid #eaf2fb;
  box-shadow: 0 15px 50px rgba(15, 70, 140, 0.15);
  display: flex;
  flex-direction: column;
  opacity: 0;
  transform: translateY(40px) scale(.96);
  pointer-events: none;
  transition: all .3s cubic-bezier(.2,.9,.2,1);
  z-index: 100;
}

.drawer.open {
  opacity: 1;
  transform: translateY(0) scale(1);
  pointer-events: auto;
}

.drawer .head {
  padding: 16px 18px;
  border-bottom: 1px solid #eef4fc;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.drawer .head strong {
  font-size: 17px;
  color: var(--primary);
}

.drawer .body {
  padding: 18px;
  overflow-y: auto;
  max-height: 60vh;
}

.drawer label {
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 4px;
  display: block;
}

.drawer textarea,
.drawer input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #e6eef8;
  font-size: 14px;
}

.status-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 6px;
}

.status-row .status-badge {
  padding: 6px 12px !important;
  font-size: 12px !important;
  border-radius: 999px;
  cursor: pointer;
  transition: background .2s, opacity .2s;
}

.drawer .footer {
  padding: 16px 18px;
  border-top: 1px solid #eef4fc;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* MOBILE FULLSCREEN DRAWER */
@media (max-width: 650px) {
  .drawer {
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 92vh !important;
    max-width: 100% !important;
    border-radius: 20px 20px 0 0 !important;
    transform: translateY(100%) !important;
  }

  .drawer.open {
    transform: translateY(0) !important;
  }

  .drawer .body {
    max-height: calc(92vh - 160px) !important;
    padding: 20px;
  }

  .drawer .head {
    padding: 18px;
  }

  .drawer .footer {
    padding: 18px;
  }
}


  /* Buttons / disabled */
  .btn.ghost{background:#fff;border:1px solid #e6eef8}
  .disabled{opacity:.55;cursor: not-allowed;}

  /* Loading spinner */
  .spinner{display:inline-block;width:18px;height:18px;border-radius:50%;border:2px solid rgba(0,0,0,0.08);border-top-color:var(--primary);animation:spin .9s linear infinite;vertical-align:middle;margin-left:8px}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* Toast */
  .toaster{position:fixed;left:50%;transform:translateX(-50%);bottom:34px;z-index:110;display:flex;flex-direction:column;gap:8px;align-items:center}
  .toast{background:rgba(17,24,39,0.98);color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(2,6,23,0.24);min-width:180px;text-align:center;opacity:0;transform:translateY(8px);transition:all .26s ease}
  .toast.show{opacity:1;transform:translateY(0)}

  /* Bottom nav for mobile */
  .bottom-nav{position:fixed;left:0;right:0;bottom:0;background:var(--panel);display:flex;gap:0;border-top:1px solid #eef6ff;z-index:70;justify-content:space-around;padding:8px 6px}
  .bottom-nav a{flex:1;text-align:center;padding:8px 6px;color:var(--muted);text-decoration:none;font-weight:700}
  .bottom-nav a.active{color:var(--primary)}

  /* small screen list cards */
  @media (max-width:650px){
    table{display:none}
    .list-cards{display:block}
    .job-card{background:#fff;padding:12px;border-radius:12px;border:1px solid #eef6fb;margin-bottom:10px}
    .job-row{display:flex;justify-content:space-between;gap:8px;align-items:center}

    .job-card-bottom {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 4px;
}

/* Make Details button look cleaner on mobile */
.job-details-btn {
  padding: 6px 12px;
  font-size: 12px;
  border-radius: 8px;
  border: 1px solid #e6eef8;
  background: #fff;
  font-weight: 700;
}

  }
  @media (min-width:651px){
    .list-cards{display:none}
  }

  /* ===============================
   MOBILE FIX PACK (IMPORTANT)
   =============================== */
@media (max-width: 650px) {

  html, body {
    overflow-x: hidden !important;
    width: 100%;
  }

  /* HEADER */
  .header {
    padding: 10px 14px;
  }
  .brand img {
    height: 30px;
  }

  /* PAGE CONTAINER */
  .page {
    padding: 0 10px;
    margin-top: 10px;
  }

  /* TABLE hidden on mobile */
  .table-wrap {
    display: none !important;
  }

  /* SHOW MOBILE CARDS */
  .list-cards {
    display: block !important;
  }

  /* JOB CARD */
  .job-card {
    padding: 14px 12px;
    border-radius: 14px;
    border: 1px solid #e4eaf3;
    background: #fff;
    margin-bottom: 12px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.04);
  }

  .job-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
  }

  .job-row div:first-child {
    width: 65%;
  }

  .job-row div:last-child {
    width: 35%;
    text-align: right;
  }

  .job-card button {
    padding: 6px 10px;
    font-size: 12px;
    border-radius: 8px;
  }

  /* STATUS BADGES SMALLER */
  .status-badge {
    font-size: 12px !important;
    padding: 4px 8px !important;
  }

  /* COUNTERS */
  .chip {
    font-size: 12px;
    padding: 4px 8px;
  }

  /* SEARCH + FILTERS STACK */
  .filters {
    flex-direction: column;
    width: 100%;
    gap: 6px;
  }
  .filters input,
  .filters select {
    width: 100%;
    font-size: 14px;
    padding: 8px 10px;
  }
  .filters button {
    width: 100%;
  }

  /* DRAWER = FULLSCREEN ON MOBILE */
  .drawer {
    right: 0 !important;
    left: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    height: 95vh !important;
    border-radius: 16px 16px 0 0 !important;
    transform: translateY(120%) scale(1) !important;
    opacity: 0;
    transition: transform .28s cubic-bezier(.2,.9,.2,1), opacity .2s ease;
  }

  .drawer.open {
    transform: translateY(0) !important;
    opacity: 1 !important;
  }

  .drawer .body {
    max-height: calc(95vh - 140px) !important;
  }

  /* DRAWER INPUTS */
  #dwNotes,
  #dwRequestAmount {
    font-size: 14px;
  }

  /* BOTTOM NAV ALWAYS ON MOBILE */
  .bottom-nav {
    display: flex !important;
    padding-top: 6px;
    padding-bottom: 6px;
  }

  .bottom-nav a {
    font-size: 12px;
  }
}

  /* ============================
   YOUTUBE-STYLE TOP PROGRESS BAR
   ============================ */
#topProgressBar {
  position: fixed;
  top: 0;
  left: 0;
  height: 3px;
  width: 0%;
  background: var(--primary);
  z-index: 9999;
  transition: width 0.35s ease;
}

</style>
</head>
<body>

  <div id="topProgressBar"></div>


<!-- Header -->
<header class="header">
  <div class="brand"><img src="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/mainlogog-removebg-preview.png" alt="HomeGlitz logo"></div>
  <div class="header-right">
    <div id="navAvatar" style="display:none"></div>
    <div style="font-size:14px;color:var(--muted);" id="cleanerNameTop"></div>
    <button class="btn ghost" id="btnLogout" aria-label="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
  </div>
</header>

<!-- Page -->
<main class="page">
  <div class="grid">

    <!-- Main -->
    <section>
      <div class="card">
        <div class="top-controls">
          <div style="display:flex;align-items:center;gap:12px;">
            <h4 style="margin:0;color:var(--primary)">Queue</h4>
              <div class="summary">
                <div class="chip icon-chip" id="countPending" title="Pending">
                  ‚è≥
                </div>
                <div class="chip icon-chip" id="countUnderway" title="Underway">
                  üöÄ
                </div>
                <div class="chip icon-chip" id="countCompleted" title="Completed">
                  ‚úîÔ∏è
                </div>
              </div>

          </div>

          <div class="filters" role="search" aria-label="Job filters">
            <input id="q" placeholder="Search property, notes or booking..." aria-label="Search jobs">
            <select id="filterStatus" aria-label="Filter status">
              <option value="all">All statuses</option>
              <option value="Pending">Pending</option>
              <option value="Clean Underway">Clean Underway</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
            </select>
            <button class="btn btn-primary" id="btnRefresh">Refresh</button>
          </div>
        </div>

        <div id="jobsContainer">
          <div class="table-wrap">
            <table aria-live="polite" id="jobsTable">
              <thead>
                <tr><th>Booking</th><th>Property</th><th>Cleaner</th><th>Date</th><th>Status</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <tr><td colspan="6" style="text-align:center;margin-bottom:100px;color:var(--muted);padding:40px">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>

          <!-- mobile card list -->
          <div class="list-cards" id="listCards" aria-hidden="true"></div>
        </div>

        <div style="margin-top:12px;margin-bottom:35px;font-size:13px;color:var(--muted)" id="inlineMsg"></div>
      </div>
    </section>

    <!-- Side (desktop) -->
    <aside class="side" aria-labelledby="profileTitle">
      <div class="profile">
        <div class="avatar" id="sideAvatar">CL</div>
        <div>
          <div id="sideName" style="font-weight:800">Cleaner</div>
          <div id="sideEmail" style="color:var(--muted);font-size:13px"></div>
        </div>
      </div>
      <nav>
        <a href="/homeglitz/cleaner/payments.html"><i class="fa-solid fa-wallet" style="margin-right:8px"></i> Payments</a>
        <a href="/homeglitz/others/cleaner-invoices.html"><i class="fa-solid fa-file-invoice" style="margin-right:10px"></i> Invoices</a>
      </nav>
    </aside>
  </div>
</main>

<!-- Drawer -->
  <aside id="drawer" class="drawer" role="dialog" aria-hidden="true" aria-labelledby="dwBookingId">

  <!-- Header -->
  <div class="head">
    <div style="display:flex; flex-direction:column;padding-top:15px;">
      <strong id="dwBookingId">Booking</strong>

      <div id="dwPropName" 
           style="font-size:14px; color:var(--muted); margin-top:2px;">
      </div>
    </div>

    <button id="btnCloseDrawer"
            style="background:none;border:none;font-size:22px;color:var(--muted);padding:6px 8px;">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>

  <!-- Body -->
  <div class="body">

    <!-- GRID: Cleaner + Date -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:18px;">
      <div>
        <label>Cleaner</label>
        <div id="dwCleaner" style="font-weight:600;"></div>
      </div>

      <div>
        <label>Date</label>
        <div id="dwDate" style="font-weight:600;"></div>
      </div>
    </div>

    <!-- STATUS SECTION -->
    <div style="margin-bottom:20px;">
      <label>Status</label>

      <div class="status-row" style="margin-top:10px;">
        <button class="status-badge s-pending" data-status="Pending">Pending</button>
        <button class="status-badge s-underway" data-status="Clean Underway">Underway</button>
        <button class="status-badge s-completed" data-status="Completed">Completed</button>
        <button class="status-badge s-cancelled" data-status="Cancelled">Cancelled</button>
      </div>
    </div>


    <!-- PACKING SLIP COLLAPSIBLE -->
<div id="dwPackingSlipWrapper" 
     style="margin-bottom:20px; display:none;">

  <!-- HEADER -->
  <div id="dwPackingSlipHeader"
       style="
         display:flex;
         justify-content:space-between;
         align-items:center;
         padding:12px 14px;
         background:#f9fbff;
         border:1px solid #e6eef8;
         border-radius:12px;
         cursor:pointer;
         font-weight:700;
         color:var(--primary);
         user-select:none;
       ">
    <span><i class="fa-solid fa-box-open"></i> Packing Slip</span>
    <i id="dwPackingSlipChevron" 
       class="fa-solid fa-chevron-down"
       style="transition:transform .25s ease;"></i>
  </div>

  <!-- COLLAPSIBLE BODY -->
  <div id="dwPackingSlipBody"
       style="
         max-height:0;
         overflow:hidden;
         background:#ffffff;
         border:1px solid #e6eef8;
         border-top:none;
         border-radius:0 0 12px 12px;
         transition:max-height .28s ease;
         padding:0 14px;
       ">
    <div id="dwPackingSlipContent"
         style="padding:12px 0; font-size:14px; line-height:1.5;">
    </div>
  </div>

</div>

    <!-- NOTES SECTION -->
    <div style="margin-bottom:22px;">
      <label>Notes</label>
      <textarea id="dwNotes"
        rows="4"
        style="width:100%;padding:12px;border-radius:10px;border:1px solid #e6eef8;font-size:14px;"></textarea>
    </div>

    <!-- PAYMENT SECTION -->
    <div style="
      background:#f9fbff;
      padding:14px;
      border:1px solid #e6eef8;
      border-radius:12px;
      margin-bottom:20px;">
      <label style="display:block;margin-bottom:6px;">Payment amount</label>

      <div style="display:flex; align-items:center; gap:10px;">
        <input id="dwRequestAmount"
          placeholder="Amount (ex GST)"
          inputmode="numeric"
          style="padding:10px;
                 border-radius:10px;
                 border:1px solid #dfe7f2;
                 width:150px;
                 font-size:14px;">
        <div style="font-size:13px;color:var(--muted);line-height:1.3;">
          Allowed only when<br><strong>job is Completed</strong>
        </div>
      </div>
    </div>

  </div>

  <!-- Footer -->
  <div class="footer" style="padding:14px; border-top:1px solid #eef4fc;">
    <button class="btn ghost" id="btnSaveStatus">Save Status</button>
    <button class="btn btn-primary" id="btnRequestPayment">Request Payment</button>
  </div>

</aside>


<!-- Mobile bottom nav -->
<nav class="bottom-nav" role="navigation" aria-label="Primary">
  <a href="#" class="active"><i class="fa-solid fa-list-check"></i><div style="font-size:12px">Jobs</div></a>
  <a href="/homeglitz/cleaner/payments.html"><i class="fa-solid fa-wallet"></i><div style="font-size:12px">Payments</div></a>
  <a href="/homeglitz/others/coming-soon.html"><i class="fa-solid fa-gear"></i><div style="font-size:12px">Account</div></a>
</nav>

<!-- Toast container -->
<div class="toaster" id="toaster" aria-live="polite" aria-atomic="true"></div>

<script>
/* ===========================
   CONFIG - set your worker
   =========================== */
const PROXY_BASE = "https://homeglitz.raphaellevinders.workers.dev/"; // <- keep as-is or update
const tokenKey = 'homeglitz_cleaner_token';
let AUTO_PAUSE = false;



/**
 * Adds +1 day for display only (timezone correction)
 * and formats as:  Thu, 28 Nov 2025 ‚Äî 10:45 AM
 * Works safely for both backend UTC and frontend local times.
 */
function formatDateCell(v) {
  if (!v) return '';
  try {
    const d = new Date(v);
    if (isNaN(d)) return v;

    // ‚úÖ Add +1 day for timezone correction
    d.setDate(d.getDate() + 1);

    // üß≠ Format: D/M/YYYY (no leading zeros)
    const day = d.getDate();
    const month = d.getMonth() + 1;
    const year = d.getFullYear();

    return `${day}/${month}/${year}`;
  } catch {
    return v;
  }
}


  

/* ---------------------------
   small UI helpers
   --------------------------- */
const toaster = document.getElementById('toaster');
function showToast(text, { duration=3000 } = {}) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.innerHTML = text;
  toaster.appendChild(el);
  // show
  requestAnimationFrame(()=> el.classList.add('show'));
  setTimeout(()=> {
    el.classList.remove('show');
    setTimeout(()=> el.remove(), 280);
  }, duration);
}

/* spinner helper */
function attachSpinner(btn) {
  const s = document.createElement('span');
  s.className = 'spinner';
  btn.dataset._spinner = '1';
  btn.appendChild(s);
}
function removeSpinner(btn) {
  const sp = btn.querySelector('.spinner');
  if (sp) sp.remove();
  delete btn.dataset._spinner;
}

/* el selectors */
const inlineMsg = document.getElementById('inlineMsg');
const jobsTableBody = document.querySelector('#jobsTable tbody');
const listCards = document.getElementById('listCards');
const drawer = document.getElementById('drawer');
const dwBookingId = document.getElementById('dwBookingId');
const dwPropName = document.getElementById('dwPropName');
const dwCleaner = document.getElementById('dwCleaner');
const dwDate = document.getElementById('dwDate');
const dwNotes = document.getElementById('dwNotes');
const dwRequestAmount = document.getElementById('dwRequestAmount');
const btnSaveStatus = document.getElementById('btnSaveStatus');
const btnRequestPayment = document.getElementById('btnRequestPayment');
const btnCloseDrawer = document.getElementById('btnCloseDrawer');
const btnLogout = document.getElementById('btnLogout');

const navAvatar = document.getElementById('navAvatar');
const sideAvatar = document.getElementById('sideAvatar');
const sideName = document.getElementById('sideName');
const sideEmail = document.getElementById('sideEmail');
const cleanerNameTop = document.getElementById('cleanerNameTop');

let PROPERTIES = [];
let JOBS = [];
let CURRENT = null;
let token = localStorage.getItem(tokenKey);

/* Redirect to login helper */
function redirectToLogin() {
  localStorage.removeItem(tokenKey);
  window.location.href = '/homeglitz/cleaner/login.html';
}

/* ---------------------------
   Fetch wrapper (worker)
   --------------------------- */
async function fetchApi(payload) {
  try {
    const res = await fetch(PROXY_BASE, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const text = await res.text();
    try { return JSON.parse(text); } catch(e){ throw new Error('Invalid JSON from backend'); }
  } catch (err) {
    throw err;
  }
}

/* ---------------------------
   Load tasks
   --------------------------- */
async function loadTasks() {
  progressStart(); // üî• start progress bar
  inlineMsg.textContent = '';
  try {
    const json = await fetchApi({ action: 'getCleanerTasks', token });
    if (!json || !json.success) {
      if (json && json.message && json.message.toLowerCase().includes('session')) return redirectToLogin();
      inlineMsg.textContent = json && json.message ? json.message : 'Unable to load tasks';
      renderJobs([]);
      return;
    }
    // refresh token if provided
    if (json.newToken) { token = json.newToken; localStorage.setItem(tokenKey, token); }
    JOBS = json.tasks || [];
    renderJobs(JOBS);
    updateCounts(JOBS);
    inlineMsg.textContent = '';
  } catch (err) {
    console.error(err);
    inlineMsg.textContent = 'Network error';
    renderJobs([]);
  }
  finally {
      progressFinish(); // üî• finish bar
  }
}

/* ---------------------------
   UI rendering
   --------------------------- */
function updateCounts(list) {
  const pending = list.filter(r => (r.Status || '') === 'Pending').length || 0;
  const underway = list.filter(r => (r.Status || '') === 'Clean Underway').length || 0;
  const completed = list.filter(r => (r.Status || '') === 'Completed').length || 0;

  document.getElementById('countPending').setAttribute('data-count', pending);
  document.getElementById('countUnderway').setAttribute('data-count', underway);
  document.getElementById('countCompleted').setAttribute('data-count', completed);
}


function renderJobs(rows){
  // table desktop
  if (!rows || rows.length === 0) {
    jobsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:30px">No jobs found</td></tr>';
  } else {
    jobsTableBody.innerHTML = rows.map(r => {
      const id = escapeHtml(r['Booking ID'] || '');
      const prop = escapeHtml(r['Property Name'] || r['Property'] || '');
      const cleaner = escapeHtml(r['Cleaners'] || '');
      const date = r['Cleaning Date'] ? formatDateCell(r['Cleaning Date']) : '';
      const status = r['Status'] || 'Pending';
      const statusClass = status === 'Pending' ? 's-pending' : status === 'Clean Underway' ? 's-underway' : status === 'Completed' ? 's-completed' : 's-cancelled';
      return `<tr data-id="${id}"><td>${id}</td><td>${prop}</td><td>${cleaner}</td><td>${date}</td><td><span class="status-badge ${statusClass}">${status}</span></td><td><button class="btn ghost" data-open="${id}"><i class="fa-solid fa-pen-to-square" style="color: #142139;"></i></button></td></tr>`;
    }).join('');
  }

  // mobile cards
  if (!rows || rows.length === 0) {
    listCards.innerHTML = '<div style="color:var(--muted);padding:16px;text-align:center">No jobs found</div>';
  } else {
listCards.innerHTML = rows.map(r => {
  const id = escapeHtml(r['Booking ID'] || '');
  const prop = escapeHtml(r['Property Name'] || r['Property'] || '');
  const date = r['Cleaning Date'] ? formatDateCell(r['Cleaning Date']) : '';
  const status = r['Status'] || 'Pending';

  // status ‚Üí badge class
  const statusClass =
    status === 'Pending'
      ? 's-pending'
      : status === 'Clean Underway'
      ? 's-underway'
      : status === 'Completed'
      ? 's-completed'
      : 's-cancelled';

  return `
    <div class="job-card" data-id="${id}">
      
      <!-- TOP: Property name + booking info -->
      <div style="margin-bottom:10px">
        <div style="font-weight:700; font-size:15px; color:#0F72B4;">${prop}</div>
        <div style="font-size:12px; color:var(--muted); margin-top:2px;">
          ${id} ¬∑ ${date}
        </div>
      </div>

      <!-- BOTTOM ROW: status badge + Details button -->
      <div class="job-card-bottom">
        <span class="status-badge ${statusClass}" style="font-size:12px;">${status}</span>
        <button class="btn ghost job-details-btn" data-open="${id}">
          <i class="fa-solid fa-pen-to-square" style="color: #142139;"></i>
        </button>
      </div>

    </div>`;
}).join('');

  }

  // wire up details buttons
  document.querySelectorAll('[data-open]').forEach(b => {
    b.addEventListener('click', (e) => {
      const id = b.getAttribute('data-open');
      openDrawer(id);
    });
  });
}

/* ---------------------------
   Drawer open/close
   --------------------------- */

  /* ============================================================
   Check if Payment Request already exists for this booking
   ============================================================ */
async function checkExistingPaymentRequest(bookingId) {
  try {
    const json = await fetchApi({
      action: 'checkPaymentRequest',
      bookingId
    });
    return json && json.exists; // true if payment exists
  } catch (err) {
    console.error('Payment check failed', err);
    return false;
  }
}


  
function openDrawer(bookingId) {
  AUTO_PAUSE = true; // ‚õî pause auto-refresh

  const row = JOBS.find(r => (r['Booking ID']||'') === bookingId);
  if (!row) return showToast('Job not found', {duration:2000});
  CURRENT = row;

  dwBookingId.textContent = bookingId;
  dwPropName.textContent = row['Property Name'] || '';
  dwCleaner.textContent = row['Cleaners'] || '';
  dwDate.textContent = row['Cleaning Date'] ? formatDateCell(row['Cleaning Date']) : '';
  dwNotes.value = row['Notes'] || row['Note'] || '';
  dwRequestAmount.value = row['Request Amount'] || '';

/* =====================================================
   PACKING SLIP
   ===================================================== */
const wrapper = document.getElementById('dwPackingSlipWrapper');
const content = document.getElementById('dwPackingSlipContent');
const body = document.getElementById('dwPackingSlipBody');
const chev = document.getElementById('dwPackingSlipChevron');
const propName = row['Property Name']?.trim() || row['Property']?.trim() || "";
const prop = PROPERTIES.find(p => (p['Property Name'] || "").trim() === propName);

// Detect if any meaningful inventory exists
let hasInventory = false;

if (prop) {
hasInventory = Object.entries(prop).some(([k, v]) => {
  const key = k.toLowerCase();

  return (
    (key.includes("sheet") || key.includes("sheets") ||
     key.includes("towel") || key.includes("towels") ||
     key.includes("amenity") || key.includes("amenities") ||
     key.includes("toilet")) &&
    Number(v) > 0
  );
});

}

if (prop && hasInventory) {
  const slipHTML = buildPackingSlip(prop);
  content.innerHTML = slipHTML;
  wrapper.style.display = "block";

  // collapsed at start
  body.style.maxHeight = "0px";
  chev.style.transform = "rotate(0deg)";
} else {
  wrapper.style.display = "none";
}




  document.querySelectorAll('.status-badge[data-status]').forEach(b => {
    b.style.opacity = (b.getAttribute('data-status') === (row['Status'] || 'Pending')) ? '1' : '0.45';
  });
  CURRENT._newStatus = row['Status'] || 'Pending';

const paymentStatusRaw = (row['Payment Status'] || '').trim().toLowerCase();
const alreadyRequested =
  paymentStatusRaw === 'pending' ||
  paymentStatusRaw === 'approved' ||
  paymentStatusRaw === 'paid';

  /* ============================================================
   When job is Completed ‚Üí Only Request Payment should show
   ============================================================ */
const isCompleted = (row['Status'] || '') === 'Completed';

  
  drawer.classList.add('open');
  drawer.setAttribute('aria-hidden','false');

  /* ============================================================
   üí≥ Payment Request Existence Check (UI + Disable Buttons)
   ============================================================ */
(async () => {
  const exists = await checkExistingPaymentRequest(bookingId);
  const noticeId = 'paymentNotice';
  let notice = document.getElementById(noticeId);

  // Remove previous notice if any
  if (notice) notice.remove();

  if (exists) {
    // Create polished UI notice
    notice = document.createElement('div');
    notice.id = noticeId;
    notice.innerHTML = `
      <div style="
        background:#fff8e6;
        border:1px solid #ffe8b3;
        color:#9a6200;
        border-radius:12px;
        padding:10px 14px;
        margin-top:10px;
        font-weight:600;
        text-align:center;
      ">
        <i class="fa-solid fa-circle-info"></i> Payment request already submitted for this job.
      </div>
    `;
    // Insert at top of drawer body
    const body = drawer.querySelector('.body');
    const paymentSection = body.querySelector('#dwRequestAmount').closest('div');
    body.insertBefore(notice, paymentSection);


    // Disable both buttons
    btnSaveStatus.classList.add('disabled');
    btnSaveStatus.disabled = true;

    btnRequestPayment.classList.add('disabled');
    btnRequestPayment.disabled = true;
  } else {
    // Ensure they‚Äôre active if no payment exists
    btnSaveStatus.classList.remove('disabled');
    btnSaveStatus.disabled = false;

    btnRequestPayment.classList.remove('disabled');
    btnRequestPayment.disabled = false;
  }
})();


  document.getElementById('dwNotes').focus();
}


function closeDrawer() {
  drawer.classList.remove('open');
  drawer.setAttribute('aria-hidden','true');
  CURRENT = null;

  AUTO_PAUSE = false; // ‚úÖ resume auto-refresh
}


function setPaymentEnabled(enabled) {
  // Always enabled
  dwRequestAmount.removeAttribute('disabled');
  btnRequestPayment.classList.remove('disabled');
}


/* ---------------------------
   Status click handlers (in drawer)
   --------------------------- */
document.querySelectorAll('.status-badge[data-status]').forEach(btn => {
  btn.addEventListener('click', () => {

    if (!CURRENT) return;

    // Visually highlight selected
    document.querySelectorAll('.status-badge[data-status]').forEach(b => b.style.opacity = 0.45);
    btn.style.opacity = 1;

    const newStatus = btn.getAttribute('data-status');
    CURRENT._newStatus = newStatus;
    CURRENT.Status = newStatus;

    const paymentStatusRaw = (CURRENT['Payment Status'] || '').trim().toLowerCase();
    const alreadyRequested =
      paymentStatusRaw === 'pending' ||
      paymentStatusRaw === 'approved' ||
      paymentStatusRaw === 'paid';

    // Enable only when status becomes Completed
    setPaymentEnabled(newStatus === 'Completed');
  });
});



/* Close drawer */
btnCloseDrawer.addEventListener('click', closeDrawer);

/* ---------------------------
   Save status action
   --------------------------- */
btnSaveStatus.addEventListener('click', async () => {
  if (!CURRENT) return;
  const newStatus = CURRENT._newStatus || CURRENT['Status'] || 'Pending';
  const notes = dwNotes.value || '';
  // show processing
  btnSaveStatus.classList.add('disabled');
  attachSpinner(btnSaveStatus);
  try {
const subAction =
  newStatus === 'Clean Underway' ? 'start' :
  newStatus === 'Completed' ? 'complete' :
  newStatus === 'Cancelled' ? 'cancel' :
  'saveStatus';

const json = await fetchApi({
  action: 'updateCleanerTask',
  subAction,
  token,
  bookingId: CURRENT['Booking ID'],
  status: newStatus,
  notes
});

    if (!json || !json.success) {
      showToast((json && json.message) ? json.message : 'Save failed', {duration:3500});
      return;
    }
    if (json.newToken) { token = json.newToken; localStorage.setItem(tokenKey, token); }

    /* üî• IMPORTANT FIX: Sync local status with newly saved status */
    CURRENT.Status = CURRENT._newStatus;
    
    showToast('Saved', {duration:1800});
    // reload tasks (server source of truth)
setTimeout(async () => {
  await loadTasks();   // fetch fresh tasks
  renderJobs(JOBS);    // re-render UI with updated statuses
  closeDrawer();       // now close drawer
}, 300);
  } catch (err) {
    console.error(err);
    showToast('Network error ‚Äî could not save', {duration:3500});
  } finally {
    removeSpinner(btnSaveStatus);
    btnSaveStatus.classList.remove('disabled');
  }
});


  btnRequestPayment.addEventListener('click', async () => {
  if (!CURRENT) return;

  const amountRaw = dwRequestAmount.value.trim();
  if (!amountRaw || isNaN(Number(amountRaw))) {
    showToast('Enter a valid amount', { duration: 2800 });
    return;
  }

  const amount = Number(amountRaw);

  // No restrictions ‚Äî always allow
  btnRequestPayment.classList.add('disabled');
  attachSpinner(btnRequestPayment);

  try {
    const json = await fetchApi({
      action: 'requestPayment',
      token,
      bookingId: CURRENT['Booking ID'],
      amount
    });

    if (!json || !json.success) {
      showToast(json?.message || 'Request failed', { duration: 3500 });
      return;
    }

    if (json.newToken) {
      token = json.newToken;
      localStorage.setItem(tokenKey, token);
    }

    showToast('Payment request sent', { duration: 3500 });

    CURRENT['Payment Status'] = 'Pending';

    // DO NOT disable ‚Äî allow multiple if needed
    btnRequestPayment.classList.remove('disabled');

    setTimeout(loadTasks, 700);
    closeDrawer();
  } catch (err) {
    console.error(err);
    showToast('Network error ‚Äî could not send request', { duration: 3500 });
  } finally {
    removeSpinner(btnRequestPayment);
    btnRequestPayment.classList.remove('disabled');
  }
});


/* ---------------------------
   Search / filters
   --------------------------- */
document.getElementById('q').addEventListener('input', applyFilters);
document.getElementById('filterStatus').addEventListener('change', applyFilters);
document.getElementById('btnRefresh').addEventListener('click', () => { loadTasks(); showToast('Refreshing‚Ä¶', {duration:2500}); });

function applyFilters() {
  const q = (document.getElementById('q').value || '').toLowerCase().trim();
  const s = document.getElementById('filterStatus').value;
  const filtered = JOBS.filter(r => {
    if (s !== 'all' && (r['Status']||'') !== s) return false;
    const hay = ((r['Property Name']||'') + ' ' + (r['Notes']||'') + ' ' + (r['Booking ID']||'')).toLowerCase();
    if (q && !hay.includes(q)) return false;
    return true;
  });
  renderJobs(filtered);
}

/* ---------------------------
   Logout
   --------------------------- */
btnLogout.addEventListener('click', () => {
  localStorage.removeItem(tokenKey);
  localStorage.removeItem('homeglitz_cleaner_id');
  localStorage.removeItem('homeglitz_cleaner_name');
  window.location.href = '/homeglitz/cleaner/login.html';
});

/* ---------------------------
   Helpers
   --------------------------- */

function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ===============================
   PROGRESS BAR CONTROLS
   =============================== */
function progressStart() {
  const bar = document.getElementById("topProgressBar");
  bar.style.width = "0%";
  bar.style.display = "block";

  // Animate like YouTube
  setTimeout(() => (bar.style.width = "30%"), 100);
  setTimeout(() => (bar.style.width = "55%"), 300);
  setTimeout(() => (bar.style.width = "75%"), 600);
}

function progressFinish() {
  const bar = document.getElementById("topProgressBar");
  bar.style.width = "100%";

  // Hide after animation
  setTimeout(() => {
    bar.style.display = "none";
    bar.style.width = "0%";
  }, 500);
}

  async function loadPropertiesForPortal() {
  try {
    const json = await fetchApi({ action: "getAllPropertiesForPortal" });
    PROPERTIES = json.properties || [];
  } catch (e) {
    console.error("Failed to load properties:", e);
    PROPERTIES = [];
  }
}

/* ---------------------------
   Boot / session checks
   --------------------------- */
(function boot(){
  // quick session check
  token = localStorage.getItem(tokenKey);
  const cleanerName = localStorage.getItem('homeglitz_cleaner_name') || '';
  const cleanerId = localStorage.getItem('homeglitz_cleaner_id') || '';
  if (!token || !cleanerId) return redirectToLogin();

  // fill header/profile
  cleanerNameTop.textContent = cleanerName;
  sideName.textContent = cleanerName || 'Cleaner';
  sideEmail.textContent = localStorage.getItem('homeglitz_cleaner_email') || '';
  navAvatar.textContent = (cleanerName || 'CL').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
  sideAvatar.textContent = navAvatar.textContent;

(async function(){
  await loadPropertiesForPortal();  // <-- IMPORTANT
  await loadTasks();
})();

})();


function togglePackingSlip() {
  const wrap = document.getElementById("dwPackingSlipWrapper");
  const body = document.getElementById("dwPackingSlipBody");
  const chev = document.getElementById("dwPackingSlipChevron");

  if (!wrap || !body) return;

  const expanded = body.style.maxHeight && body.style.maxHeight !== "0px";

  if (expanded) {
    body.style.maxHeight = "0px";
    chev.style.transform = "rotate(0deg)";
  } else {
    body.style.maxHeight = body.scrollHeight + "px";
    chev.style.transform = "rotate(180deg)";
  }
}

document.getElementById("dwPackingSlipHeader").addEventListener("click", togglePackingSlip);


function buildPackingSlip(prop) {
  if (!prop) return "";

  const excluded = ["Property Name"];

  // Build a list from dynamic keys
  const list = Object.entries(prop)
    .filter(([k, v]) => !excluded.includes(k) && v !== "" && v !== null)
    .map(([k, v]) => {
      return `
        <div style="margin-bottom:10px;">
          <div style="font-weight:700; color:#0F72B4;">${k}</div>
          <div style="font-size:14px; color:#444;">${v}</div>
        </div>
      `;
    })
    .join("");

  if (!list) {
    return "<div style='color:#777;'>No packing details available.</div>";
  }

  return `<div>${list}</div>`;
}



</script>
</body>
</html>
