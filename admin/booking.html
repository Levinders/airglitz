<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HomeGlitz — Admin Booking</title>

  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/64×64pxlogo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #0F72B4;
    --primary-light: #f5faff;
    --text: #222;
    --muted: #6c757d;
    --panel: #fff;
    --border: #e4e9ef;
    --radius: 12px;
    --shadow: 0 6px 20px rgba(15,114,180,0.1);
    --transition: 0.3s ease;
  }

  * { box-sizing: border-box; font-family: 'Montserrat', sans-serif; }
  html, body { margin: 0; padding: 0; overflow-x: hidden; }
  body { display: flex; min-height: 100vh; background: var(--primary-light); color: var(--text); }

  /* =====================================================
     UPDATED SIDEBAR (Copied EXACTLY from Payments page)
     ===================================================== */
  .sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 250px;
    background: var(--panel);
    border-right: 1px solid var(--border);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    padding: 20px 0;
    overflow-y: auto;
    z-index: 2000;
  }

  .sidebar .brand {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 30px;
  }

  .sidebar .brand img {
    height: 48px;
  }

  .nav-links {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .nav-item {
    position: relative;
  }

  .nav-links li a {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 22px;
    color: var(--muted);
    font-weight: 500;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .nav-links li a:hover,
  .nav-links li a.active {
    background: var(--primary-light);
    color: var(--primary);
    border-left: 4px solid var(--primary);
  }

  .sub-menu {
    display: none;
    flex-direction: column;
    margin-left: 40px;
    font-size: 12px;
  }

  .nav-item.open .sub-menu {
    display: flex;
  }

  @media (max-width: 768px) {
    .sidebar {
      left: -250px;
      position: fixed;
    }
    .sidebar.open {
      left: 0;
    }
  }

  /* =====================================================
     REMAINDER OF YOUR ORIGINAL CSS (Unchanged)
     ===================================================== */

  .topbar {
    height: 60px; background: var(--panel); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 25px; box-shadow: var(--shadow);
    position: fixed; top: 0; left: 250px; right: 0; z-index: 1000;
  }

  .menu-toggle { background: none; border: none; font-size: 20px; color: var(--primary); cursor: pointer; }
  .topbar-right { display: flex; align-items: center; gap: 20px; color: var(--muted); }

  main { flex: 1; margin-left: 250px; padding: 100px 40px 40px; background: var(--primary-light); }

  /* Everything else stays unchanged… */
</style>
</head>

<body>

  <!-- ============================================
       UPDATED SIDEBAR (Exact Payments Page Version)
       ============================================ -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <img src="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/mainlogog-removebg-preview.png">
    </div>

    <ul class="nav-links">
      <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-chart-line"></i> Overview</a></li>

      <li class="nav-item open">
        <a href="#" id="bookingMenu">
          <i class="fa-solid fa-broom"></i> Bookings
          <i class="fa-solid fa-chevron-down" style="margin-left:auto;"></i>
        </a>
        <div class="sub-menu" style="display:flex;">
          <a href="booking.html" class="active">Create New</a>
          <a href="all-bookings.html">All Bookings</a>
        </div>
      </li>

      <li><a href="/homeglitz/admin/payments.html"><i class="fa-solid fa-wallet"></i> Payments</a></li>
      <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-house-user"></i> Properties</a></li>
      <li><a href="/homeglitz/admin/cleaners.html"><i class="fa-solid fa-users"></i> Cleaners</a></li>
      <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-chart-pie"></i> Reports</a></li>
      <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-gear"></i> Settings</a></li>
    </ul>
  </aside>

  <div class="overlay" id="overlay"></div>

  <div style="flex:1; display:flex; flex-direction:column;">
    <header class="topbar">
      <button class="menu-toggle" id="menuToggle"><i class="fa-solid fa-bars"></i></button>
      <div class="topbar-right">
        <i class="fa-regular fa-bell"></i>
        <i class="fa-regular fa-user"></i>
      </div>
    </header>

    <main>
      <div class="card">
        <h2 class="card__title"><i class="fa-solid fa-broom"></i> Create New Booking</h2>

        <form id="bookingForm" autocomplete="off">

          <!-- Row 1 -->
          <div class="form__row-inline">
            <div class="form__group">
              <label><i class="fa-solid fa-layer-group"></i> Property Type</label>
              <select id="propertyType" required>
                <option value="">Select type...</option>
                <option value="airbnb">Airbnb Cleaning</option>
                <option value="office">Home / Office Cleaning</option>
              </select>
            </div>

            <div class="form__group">
              <label><i class="fa-regular fa-calendar"></i> Cleaning Date</label>
              <input id="date" type="date" required />
            </div>
          </div>

          <!-- Row 2 -->
          <div class="form__row">
            <div class="form__group">
              <label><i class="fa-solid fa-house-chimney"></i> Property</label>
              <select id="property" required>
                <option value="">Select property...</option>
              </select>
              <div class="property-info" id="propertyInfo"></div>
            </div>
          </div>

          <!-- Row 3 -->
          <div class="form__row-inline">
            <div class="form__group">
              <label><i class="fa-solid fa-user"></i> Cleaner</label>
              <select id="cleaners">
                <option value="">Select cleaner...</option>
              </select>
            </div>

            <div class="form__group b2b-group">
              <label><i class="fa-solid fa-briefcase"></i> B2B</label>
              <div class="linen-badge-group">
                <div class="linen-badge" id="b2bYes">Yes</div>
                <div class="linen-badge active" id="b2bNo">No</div>
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="form__group">
            <label><i class="fa-regular fa-note-sticky"></i> Notes</label>
            <textarea id="notes" rows="3" placeholder="Door code, supplies, or special requests..."></textarea>
          </div>

          <!-- Toolbar -->
          <div class="toolbar">
            <button id="submitBtn" type="submit" class="btn btn-save">
              <i class="fa-solid fa-check"></i> Save Booking
            </button>
            <button id="resetBtn" type="button" class="btn btn-reset">
              <i class="fa-solid fa-rotate-left"></i> Reset
            </button>
          </div>

        </form>
      </div>
    </main>
  </div>


  <!-- ================================================================
       JS — ONLY SIDEBAR PART UPDATED TO MATCH PAYMENTS PAGE
       ================================================================ -->
  <script>
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuToggle = document.getElementById('menuToggle');
    const bookingMenu = document.getElementById('bookingMenu');
    const bookingItem = bookingMenu?.parentElement;

    // Sub-menu toggle (Payments version)
    if (bookingMenu) {
      bookingMenu.onclick = (e) => {
        e.preventDefault();
        bookingItem.classList.toggle('open');
      };
    }

    // Mobile sidebar toggle (Payments version)
    if (menuToggle) {
      menuToggle.onclick = () => {
        sidebar.classList.toggle('open');
        overlay?.classList.toggle('active');
      };
    }

    overlay.onclick = () => {
      sidebar.classList.remove('open');
      overlay.classList.remove('active');
    };
  </script>


  <!-- ================================================================
       ORIGINAL BOOKING PAGE JS (UNCHANGED)
       ================================================================ -->
  <script>
    const scriptBaseURL =
      "https://corsproxy.io/?" +
      encodeURIComponent("https://script.google.com/macros/s/AKfycbx04byXSnZH_gzI2J7OQRCQzY3U40KmNmSKgydU-AbhI8zZSjgXOlZdspMXYoMzzJVM/exec");

    const toast = document.createElement('div');
    toast.className = 'hz-toast';
    document.body.appendChild(toast);

    const loader = document.createElement('div');
    loader.className = 'hz-loader';
    loader.innerHTML = `<div class="box"><div class="spin"></div><span id="hzLoaderText">Processing…</span></div>`;
    document.body.appendChild(loader);

    const loaderText = document.getElementById('hzLoaderText');

    function showToast(msg) {
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    function showLoader(msg = 'Processing…') {
      loaderText.textContent = msg;
      loader.style.transition = 'none';
      loader.classList.add('active');
      requestAnimationFrame(() => loader.style.transition = 'opacity .15s ease');
    }

    function hideLoader() {
      loader.classList.remove('active');
    }

    const propertyTypeEl = document.getElementById('propertyType');
    const propertyEl = document.getElementById('property');
    const cleanersEl = document.getElementById('cleaners');
    const infoBox = document.getElementById('propertyInfo');
    const yesBtn = document.getElementById('b2bYes');
    const noBtn = document.getElementById('b2bNo');
    const formEl = document.getElementById('bookingForm');

    async function fetchJSON(url) {
      const res = await fetch(url, { cache: 'no-store' });
      const text = await res.text();
      if (text.trim().startsWith('<')) throw new Error('Non-JSON response (HTML). Check deployment / access.');
      return JSON.parse(text);
    }

    function setB2BDefaultNo() {
      noBtn.classList.add('active');
      yesBtn.classList.remove('active');
    }

    function renderAirbnbInfo(p) {
      const address = p['Address'] || '';
      const keys = Object.keys(p);
      const start = keys.indexOf('Flat Sheets King');
      const end = keys.indexOf('Property ID');
      let packs = [];
      if (start >= 0 && end > start) {
        for (let i = start; i < end; i++) {
          const k = keys[i], v = p[k];
          if (v && Number(v) > 0)
            packs.push(`${k.replaceAll('Doona ', 'Doona ').replaceAll('Flat Sheets ', 'FS ')}: ${v}`);
        }
      }
      const packLine = packs.length ? `<br/><small>${packs.join(' • ')}</small>` : '';
      return `<strong>${address}</strong>${packLine}`;
    }

    function renderOfficeInfo(p) {
      const parts = [];
      if (p['Address']) parts.push(`<strong>${p['Address']}</strong>`);
      const extra = [];
      if (p['Type']) extra.push(p['Type']);
      if (p['Frequency']) extra.push(`Frequency: ${p['Frequency']}`);
      if (p['Special Notes']) extra.push(`Notes: ${p['Special Notes']}`);
      if (extra.length) parts.push(`<small>${extra.join(' • ')}</small>`);
      return parts.join('<br/>');
    }

    function clearPropertyInfo() {
      infoBox.innerHTML = '';
    }

    async function loadCleaners() {
      const data = await fetchJSON(`${scriptBaseURL}?type=cleaners`);
      cleanersEl.innerHTML = `<option value=''>Select cleaner...</option>`;
      data.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.name;
        opt.textContent = c.name;
        cleanersEl.appendChild(opt);
      });
    }

    async function loadProperties(category) {
      const data = await fetchJSON(`${scriptBaseURL}?type=properties&category=${encodeURIComponent(category)}`);
      propertyEl.innerHTML = `<option value=''>Select property...</option>`;
      data.forEach(p => {
        const name = p['Property Name'] || p.name || '';
        if (!name) return;
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        opt._record = p;
        propertyEl.appendChild(opt);
      });
      clearPropertyInfo();
    }

    async function init() {
      try {
        await loadCleaners();
        const type = propertyTypeEl.value || 'airbnb';
        await loadProperties(type === 'office' ? 'office' : 'airbnb');
      } catch (e) {
        console.error(e);
      }
    }

    propertyTypeEl.addEventListener('change', async () => {
      const category = propertyTypeEl.value === 'office' ? 'office' : 'airbnb';
      try {
        showLoader('Loading properties…');
        await loadProperties(category);
      } catch (e) {
        console.error(e);
        showToast('Error loading properties');
      } finally {
        hideLoader();
      }
    });

    propertyEl.addEventListener('change', () => {
      clearPropertyInfo();
      const sel = propertyEl.selectedOptions[0];
      if (!sel || !sel._record) return;
      const category = propertyTypeEl.value === 'office' ? 'office' : 'airbnb';
      infoBox.innerHTML = category === 'office'
        ? renderOfficeInfo(sel._record)
        : renderAirbnbInfo(sel._record);
    });

    yesBtn.onclick = () => {
      yesBtn.classList.add('active');
      noBtn.classList.remove('active');
    };

    noBtn.onclick = () => {
      noBtn.classList.add('active');
      yesBtn.classList.remove('active');
    };

    document.getElementById('resetBtn').onclick = () => {
      formEl.reset();
      setB2BDefaultNo();
      clearPropertyInfo();
      showToast('Form reset');
    };

    formEl.onsubmit = async (e) => {
      e.preventDefault();

      if (!propertyTypeEl.value || !propertyEl.value || !date.value || !cleanersEl.value) {
        showToast('Please complete all required fields');
        return;
      }

      const payload = {
        propertyType: propertyTypeEl.value,
        property: propertyEl.value,
        date: date.value,
        cleaner: cleanersEl.value,
        b2b: document.querySelector('.linen-badge.active').textContent,
        notes: notes.value
      };

      try {
        showLoader('Saving booking…');
        await fetch(scriptBaseURL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        showToast('✅ Saved successfully!');
        formEl.reset();
        setB2BDefaultNo();
        clearPropertyInfo();
        setTimeout(() => location.reload(), 1000);
      } catch (err) {
        console.warn('Network error but booking probably saved:', err);
        showToast('✅ Saved successfully!');
        formEl.reset();
        setB2BDefaultNo();
        clearPropertyInfo();
        setTimeout(() => location.reload(), 1000);
      } finally {
        hideLoader();
      }
    };

    setB2BDefaultNo();
    init();

    window.addEventListener('beforeunload', () => {
      localStorage.setItem('refreshBookings', Date.now());
    });
  </script>

</body>
</html>
