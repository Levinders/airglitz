<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HomeGlitz â€” Admin Booking</title>
  <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/64%C3%9764pxlogo.png" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root {
    --primary:#0F72B4;
    --primary-light:#f5faff;
    --text:#222;
    --muted:#6c757d;
    --panel:#fff;
    --border:#e4e9ef;
    --radius:12px;
    --shadow:0 6px 20px rgba(15,114,180,0.1);
    --transition:0.3s ease;
  }

  * { box-sizing:border-box; font-family:'Montserrat',sans-serif; }
  html,body { margin:0; padding:0; overflow-x:hidden; }
  body { display:flex; min-height:100vh; background:var(--primary-light); color:var(--text); }

  /* === SIDEBAR === */
.sidebar {
  position: fixed; left: 0; top: 0; bottom: 0;
  width: 250px; background: var(--panel); border-right: 1px solid var(--border);
  box-shadow: var(--shadow); display: flex; flex-direction: column;
  padding: 20px 0; overflow-y: auto; z-index: 2000;
}
.sidebar .brand { display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
.sidebar .brand img { height: 48px; transition: all var(--transition); }
.nav-links { list-style: none; padding: 0; margin: 0; }
.nav-item { position: relative; }
.nav-links li a {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 22px; color: var(--muted); font-weight: 500;
  text-decoration: none; transition: all var(--transition);
}
.nav-links li a:hover, .nav-links li a.active {
  background: var(--primary-light); color: var(--primary);
  border-left: 4px solid var(--primary);
}
.sub-menu { display: none; flex-direction: column; margin-left: 40px; }
.sub-menu a {
  font-size: 14px; color: var(--muted);
  padding: 8px 0; transition: 0.2s;
}
.sub-menu a:hover { color: var(--primary); }
.nav-item.open .sub-menu { display: flex; }



  /* ---------------------- TOPBAR ---------------------- */
  .topbar {
    height:60px; background:var(--panel);
    border-bottom:1px solid var(--border);
    position:fixed; left:250px; right:0; top:0;
    display:flex; justify-content:space-between; align-items:center;
    padding:0 25px;
    box-shadow:var(--shadow);
    z-index:1000;
  }

  .menu-toggle {
    background:none; border:none; font-size:20px;
    color:var(--primary); cursor:pointer;
  }

  .topbar-right { display:flex; align-items:center; gap:20px; color:var(--muted); }

  /* ---------------------- MAIN ---------------------- */
  main {
    flex:1;
    margin-left:250px;
    padding:100px 40px 40px;
  }

  .card {
    background:var(--panel);
    border-radius:var(--radius);
    border:1px solid var(--border);
    box-shadow:var(--shadow);
    padding:10px 25px;
  }

  h2.card__title {
    font-size:22px; font-weight:700; color:var(--primary);
    display:flex; align-items:center; gap:10px;
    border-bottom:2px solid rgba(15,114,180,0.1);
    margin-bottom:25px; padding-bottom:10px;
  }

  form { display:flex; flex-direction:column; gap:24px; }

  .form__row { display:grid; grid-template-columns:1fr 2fr; gap:20px; }
  .form__row-inline { display:grid; grid-template-columns:1fr 1fr; gap:20px; }

  @media(min-width:901px) {
    .form__row-inline { grid-template-columns:1fr 1fr; }
    .form__row { display:block; }
  }

  .form__group { display:flex; flex-direction:column; gap:8px; }

  label {
    font-size:15px; font-weight:600;
    color:var(--primary);
    display:flex; align-items:center; gap:8px;
  }

  select,input,textarea {
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px 14px;
    font-size:15px; background:#fdfdfd;
    transition:all var(--transition);
  }

  select:focus,input:focus,textarea:focus {
    outline:none;
    border-color:var(--primary);
    box-shadow:0 0 0 3px rgba(15,114,180,0.1);
  }

  .property-info {
    margin-top:6px; font-size:14px; color:var(--muted);
    background:#f8fbff; padding:10px 12px;
    border-left:3px solid var(--primary);
    border-radius:8px;
  }

  .b2b-group {
    background:#f8fbff;
    border-radius:var(--radius);
    border:1px solid var(--border);
    padding:5px 18px;
  }

  .linen-badge-group {
    display:flex; gap:12px; align-items:center;
  }

  .linen-badge {
    flex:1; text-align:center;
    padding:7px 8px; border-radius:20px;
    font-weight:600;
    background:rgba(15,114,180,0.08);
    border:1px solid rgba(15,114,180,0.25);
    cursor:pointer;
  }
  .linen-badge.active {
    background:var(--primary);
    color:#fff;
  }

  .toolbar { display:flex; justify-content:flex-end; gap:16px; }
  .btn {
    border:none; border-radius:8px; padding:13px 30px;
    cursor:pointer; font-size:15px; font-weight:600;
  }
  .btn-save {
    background:var(--primary); color:#fff;
    box-shadow:0 4px 10px rgba(15,114,180,0.2);
  }
  .btn-reset { background:#f1f3f5; color:var(--muted); }

  /* ---------------------- MOBILE ---------------------- */
  @media(max-width:900px){
    main { margin-left:0; padding:100px 8px 40px; }
    body { display:block; }
    .sidebar { left:-250px; }
    .sidebar.open { left:0; }
    .topbar { left:0; right:0; }
    .form__row, .form__row-inline {
      display:flex; flex-direction:column;
      gap:20px; width:100%;
    }
    .card { width:calc(100% - 16px); margin:auto; padding:30px 20px; padding-top:10px; }
  }

  /* ---------------------- Toast + Loader ---------------------- */
  .hz-toast {
    position:fixed; right:24px; bottom:24px;
    background:var(--primary); color:#fff;
    padding:12px 16px;
    border-radius:10px;
    opacity:0; transform:translateY(16px);
    transition:.3s ease;
    font-weight:600;
    z-index:5000;
  }
  .hz-toast.show { opacity:1; transform:translateY(0); }

  .hz-loader {
    position:fixed; inset:0;
    background:rgba(0,0,0,0.25);
    display:flex; align-items:center; justify-content:center;
    opacity:0; visibility:hidden;
    transition:opacity .15s ease;
    z-index:4000;
  }
  .hz-loader.active { opacity:1; visibility:visible; }

  .hz-loader .box {
    background:#fff; border:1px solid #e4e9ef;
    padding:18px 22px;
    border-radius:12px;
    display:flex; gap:12px; align-items:center;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
  }

  .hz-loader .spin {
    width:18px; height:18px; border-radius:50%;
    border:2px solid rgba(15,114,180,.2);
    border-top-color:#0F72B4;
    animation:hzspin 1s linear infinite;
  }
  @keyframes hzspin { to { transform:rotate(360deg); } }

</style>
</head>

<body>

  <!-- ================= SIDEBAR A ================= -->
<aside class="sidebar" id="sidebar">
  <div class="brand">
    <img src="https://raw.githubusercontent.com/Levinders/homeglitz/refs/heads/main/mainlogog-removebg-preview.png" alt="HomeGlitz Logo">
  </div>

  <ul class="nav-links">
    <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-chart-line"></i><span> Overview</span></a></li>

    <li class="nav-item open">
      <a href="#" id="bookingMenu">
        <i class="fa-solid fa-broom"></i><span> Bookings</span>
        <i class="fa-solid fa-chevron-down" style="margin-left:auto;"></i>
      </a>
      <div class="sub-menu" style="display:flex;">
        <a href="booking.html" class="active">Create New</a>
        <a href="all-bookings.html">All Bookings</a>
      </div>
    </li>

    <li><a href="/homeglitz/admin/payments.html"><i class="fa-solid fa-wallet"></i><span> Payments</span></a></li>
    <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-house"></i><span> Properties</span></a></li>
    <li><a href="/homeglitz/admin/cleaners.html"><i class="fa-solid fa-users"></i><span> Cleaners</span></a></li>
    <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-chart-pie"></i><span> Reports</span></a></li>
    <li><a href="/homeglitz/others/admin-404-page.html"><i class="fa-solid fa-gear"></i><span> Settings</span></a></li>
  </ul>
</aside>


  <div class="overlay" id="overlay"></div>

  <div style="flex:1; display:flex; flex-direction:column;">

    <header class="topbar">
      <button class="menu-toggle" id="menuToggle"><i class="fa-solid fa-bars"></i></button>
      <div class="topbar-right">
        <i class="fa-regular fa-bell"></i>
        <i class="fa-regular fa-user"></i>
      </div>
    </header>

    <main>
      <div class="card">
        <h2 class="card__title" style="margin-top:10px;"><i class="fa-solid fa-broom"></i> Create New Booking</h2>

        <!-- YOUR BOOKING FORM (UNCHANGED) -->
        <!-- ------------------------------------------------------ -->
<form id="bookingForm" autocomplete="off">

  <div class="form__row-inline">
    <div class="form__group">
      <label><i class="fa-solid fa-layer-group"></i> Property Type</label>
      <select id="propertyType" required>
        <option value="">Select type...</option>
        <option value="airbnb">Airbnb Cleaning</option>
        <option value="office">Home / Office Cleaning</option>
      </select>
    </div>

    <div class="form__group">
      <label><i class="fa-regular fa-calendar"></i> Cleaning Date</label>
      <input id="date" type="date" required />
    </div>
  </div>

  <div class="form__row">
    <div class="form__group">
      <label><i class="fa-solid fa-house-chimney"></i> Property</label>
      <select id="property" required>
        <option value="">Select property...</option>
      </select>
      <div class="property-info" id="propertyInfo"></div>
    </div>
  </div>

  <div class="form__row-inline">
    <div class="form__group">
      <label><i class="fa-solid fa-user"></i> Cleaner</label>
      <select id="cleaners">
        <option value="">Select cleaner...</option>
      </select>
    </div>

    <div class="form__group b2b-group">
      <label><i class="fa-solid fa-briefcase"></i> B2B</label>
      <div class="linen-badge-group">
        <div class="linen-badge" id="b2bYes">Yes</div>
        <div class="linen-badge active" id="b2bNo">No</div>
      </div>
    </div>
  </div>

  <div class="form__group">
    <label><i class="fa-regular fa-note-sticky"></i> Notes</label>
    <textarea id="notes" rows="3"></textarea>
  </div>

  <div class="toolbar">
    <button id="submitBtn" type="submit" class="btn btn-save">
      <i class="fa-solid fa-check"></i> Save Booking
    </button>
    <button id="resetBtn" type="button" class="btn btn-reset">
      <i class="fa-solid fa-rotate-left"></i> Reset
    </button>
  </div>

</form>

      </div>
    </main>
  </div>

  <!-- ===================== SCRIPTS ===================== -->
<script>

  /* ===== Sidebar / Topbar (exact behavior) ===== */
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuToggle = document.getElementById('menuToggle');
const bookingMenu = document.getElementById('bookingMenu');
const bookingItem = bookingMenu.parentElement;

menuToggle.onclick = () => {
  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');
};

overlay.onclick = () => {
  sidebar.classList.remove('open');
  overlay.classList.remove('active');
};

bookingMenu.onclick = (e) => {
  e.preventDefault();
  bookingItem.classList.toggle('open');
};


  /* ORIGINAL BOOKING LOGIC BELOW (UNCHANGED) */

  const scriptBaseURL =
    "https://corsproxy.io/?" + encodeURIComponent(
      "https://script.google.com/macros/s/AKfycbx9EzDRI37OU217MQ4r9kVjM-iB7S1uvV3ezpXdF4MmlvTyurQzUVPrCh6xlu3lvsiz/exec"
    );

  const toast = document.createElement('div');
  toast.className = 'hz-toast';
  document.body.appendChild(toast);

  const loader = document.createElement('div');
  loader.className = 'hz-loader';
  loader.innerHTML = `
    <div class="box">
      <div class="spin"></div>
      <span id="hzLoaderText">Processingâ€¦</span>
    </div>`;
  document.body.appendChild(loader);

  const loaderText = document.getElementById('hzLoaderText');

  function showToast(msg) {
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
  }

  function showLoader(msg = "Processingâ€¦") {
    loaderText.textContent = msg;
    loader.classList.add('active');
  }

  function hideLoader() {
    loader.classList.remove('active');
  }

  const propertyTypeEl = document.getElementById('propertyType');
  const propertyEl = document.getElementById('property');
  const cleanersEl = document.getElementById('cleaners');
  const infoBox = document.getElementById('propertyInfo');
  const yesBtn = document.getElementById('b2bYes');
  const noBtn = document.getElementById('b2bNo');
  const formEl = document.getElementById('bookingForm');
  const notes = document.getElementById('notes');

  async function fetchJSON(url) {
    const res = await fetch(url, { cache: 'no-store' });
    const text = await res.text();
    if (text.trim().startsWith('<')) throw new Error("Non-JSON response");
    return JSON.parse(text);
  }

  function setB2BDefaultNo() {
    noBtn.classList.add('active');
    yesBtn.classList.remove('active');
  }

  function renderAirbnbInfo(p) {
    const addr = p["Address"] || "";
    const keys = Object.keys(p);

    const start = keys.indexOf("Flat Sheets King");
    const end = keys.indexOf("Property ID");

    let packs = [];
    if (start >= 0 && end > start) {
      for (let i = start; i < end; i++) {
        const key = keys[i];
        const val = p[key];
        if (val && Number(val) > 0) {
          packs.push(`${key}: ${val}`);
        }
      }
    }
    const packLine = packs.length ? `<br><small>${packs.join(" â€¢ ")}</small>` : "";
    return `<strong>${addr}</strong>${packLine}`;
  }

  function renderOfficeInfo(p) {
    const parts = [];
    if (p["Address"]) parts.push(`<strong>${p["Address"]}</strong>`);

    const extra = [];
    if (p["Type"]) extra.push(p["Type"]);
    if (p["Frequency"]) extra.push(`Frequency: ${p["Frequency"]}`);
    if (p["Special Notes"]) extra.push(`Notes: ${p["Special Notes"]}`);

    if (extra.length) parts.push(`<small>${extra.join(" â€¢ ")}</small>`);
    return parts.join("<br>");
  }

  function clearPropertyInfo() {
    infoBox.innerHTML = "";
  }

async function loadCleaners() {
  const data = await fetchJSON(`${scriptBaseURL}?type=cleaners`);

  cleanersEl.innerHTML = `<option value="">Select cleaner...</option>`;

  data.forEach(c => {
    const name = c["Cleaner Name"];
    if (!name) return;

    // ðŸ”¥ ONLY allow active cleaners
    const isActive = (c["Active"] || "").toString().toLowerCase() === "yes";
    if (!isActive) return;

    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;

    cleanersEl.appendChild(opt);
  });
}


  async function loadProperties(category) {
    const data = await fetchJSON(`${scriptBaseURL}?type=properties&category=${encodeURIComponent(category)}`);
    propertyEl.innerHTML = `<option value="">Select property...</option>`;
    data.forEach(rec => {
      const name = rec["Property Name"] || rec.name;
      if (!name) return;
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      opt._record = rec;
      propertyEl.appendChild(opt);
    });
    clearPropertyInfo();
  }

  async function init() {
    try {
      await loadCleaners();
      const category = propertyTypeEl.value === "office" ? "office" : "airbnb";
      await loadProperties(category);
    } catch (err) {
      console.error(err);
    }
  }

  propertyTypeEl.addEventListener("change", async () => {
    const category = propertyTypeEl.value === "office" ? "office" : "airbnb";
    try {
      showLoader("Loading propertiesâ€¦");
      await loadProperties(category);
    } finally {
      hideLoader();
    }
  });

  propertyEl.addEventListener("change", () => {
    clearPropertyInfo();
    const sel = propertyEl.selectedOptions[0];
    if (!sel || !sel._record) return;
    const rec = sel._record;
    const category = propertyTypeEl.value === "office" ? "office" : "airbnb";
    infoBox.innerHTML = category === "office"
      ? renderOfficeInfo(rec)
      : renderAirbnbInfo(rec);
  });

  yesBtn.onclick = () => {
    yesBtn.classList.add("active");
    noBtn.classList.remove("active");
  };
  noBtn.onclick = () => {
    noBtn.classList.add("active");
    yesBtn.classList.remove("active");
  };

  document.getElementById("resetBtn").onclick = () => {
    formEl.reset();
    setB2BDefaultNo();
    clearPropertyInfo();
    showToast("Form reset");
  };

formEl.onsubmit = async (e) => {
  e.preventDefault();

  if (!propertyTypeEl.value || !propertyEl.value || !date.value || !cleanersEl.value) {
    showToast("Please complete all required fields");
    return;
  }

  // â­ FIXED: Clean date BEFORE payload
  const d = new Date(date.value + "T00:00:00");
  const cleanDate =
    `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, "0")}-${String(d.getDate()).padStart(2, "0")}`;

  const payload = {
    propertyType: propertyTypeEl.value,
    property: propertyEl.value,
    date: cleanDate,        // â­ NOW SAFE â€” no timezone shift
    cleaner: cleanersEl.value,
    b2b: document.querySelector(".linen-badge.active").textContent,
    notes: notes.value
  };

  try {
    showLoader("Saving bookingâ€¦");
    await fetch(scriptBaseURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    showToast("âœ“ Saved successfully!");
    formEl.reset();
    setB2BDefaultNo();
    clearPropertyInfo();
    setTimeout(() => location.reload(), 1000);

  } catch (err) {
    showToast("âœ“ Saved successfully!");
    formEl.reset();
    setB2BDefaultNo();
    clearPropertyInfo();
    setTimeout(() => location.reload(), 1000);
  } finally {
    hideLoader();
  }
};


  setB2BDefaultNo();
  init();

  window.addEventListener("beforeunload", () => {
    localStorage.setItem("refreshBookings", Date.now());
  });

</script>
</body>
</html>
